# Myomyw数据包协议 v0.8

（暂未实现）

Myomyw的数据包采用json格式发送。数据包分为三类，部分数据包发出后无需接收方回应，称为emit包；另一些数据包需要接收方回应，称为request包；回应request包的数据包为response包。

数据包均具有如下格式：

| 参数名 | 描述                                                         | 类型   |
| ------ | ------------------------------------------------------------ | ------ |
| action | 在非response包中，表示数据包的类型；在response包中，该参数为`response` | string |
| id     | 标识id，任何int，会被原样返回，在emit包中可省略              | int    |
| data   | 数据包的具体内容                                             | object |

以下均为data中的内容

## 用户和账户

### 握手

| action    | 类型             | 发送方 |
| --------- | ---------------- | ------ |
| handshake | request-response | client |

#### request

| 参数名  | 描述         | 类型   |
| ------- | ------------ | ------ |
| version | 客户端的版本 | string |

#### response

| 参数名     | 描述                   | 类型 |
| ---------- | ---------------------- | ---- |
| error_code | 0为成功，1为版本不匹配 | int  |

---

### 登录（待完善）

| action | 类型             | 发送方 |
| ------ | ---------------- | ------ |
| login  | request-response | client |

#### request

| 参数名 | 描述     | 类型   |
| ------ | -------- | ------ |
| name   | 玩家名称 | string |

#### response

| 参数名     | 描述             | 类型 |
| ---------- | ---------------- | ---- |
| error_code | 0为成功，1为失败 | int  |

---

## 房间

### 开始匹配

| action         | 类型             | 发送方 |
| -------------- | ---------------- | ------ |
| start_matching | request-response | client |

#### request

| 参数名         | 描述         | 类型 |
| -------------- | ------------ | ---- |
| allow_watching | 是否允许观战 | bool |

#### response

| 参数名     | 描述   | 类型 |
| ---------- | ------ | ---- |
| error_code | 见下表 | int  |

| error_code | 描述                   |
| ---------- | ---------------------- |
| 0          | 成功                   |
| 1          | 未登录（即未提供昵称） |
| 2          | 服务器已满             |

---

### 停止匹配

| action         | 类型 | 发送方 |
| -------------- | ---- | ------ |
| start_matching | emit | client |

（无参数）

---

### 匹配成功

| action           | 类型 | 发送方 |
| ---------------- | ---- | ------ |
| matching_success | emit | server |

| 参数名        | 描述     | 类型   |
| ------------- | -------- | ------ |
| opponent_name | 对手名称 | string |
| room_id       | 房间号   | string |

---

### 创建房间

| action      | 类型             | 发送方 |
| ----------- | ---------------- | ------ |
| create_room | request-response | client |

#### request

| 参数名         | 描述         | 类型 |
| -------------- | ------------ | ---- |
| allow_watching | 是否允许观战 | bool |

#### response

| 参数名     | 描述   | 类型   |
| ---------- | ------ | ------ |
| error_code | 见下表 | int    |
| room_id    | 房间号 | string |

| error_code | 描述                   |
| ---------- | ---------------------- |
| 0          | 成功                   |
| 1          | 未登录（即未提供昵称） |
| 2          | 服务器已满             |

---

### 观战

| action | 类型             | 发送方 |
| ------ | ---------------- | ------ |
| watch  | request-response | client |

#### request

| 参数名  | 描述   | 类型 |
| ------- | ------ | ---- |
| room_id | 房间号 | int  |

#### response

| 参数名     | 描述                           | 类型 |
| ---------- | ------------------------------ | ---- |
| error_code | 见下表                         | int  |
| turn       | 当前是谁的回合（0为左，1为右） | int  |

| error_code | 描述             |
| ---------- | ---------------- |
| 0          | 成功             |
| 1          | 房间不存在       |
| 2          | 房间不允许观战   |
| 3          | 观战人数达到上限 |

---

## 游戏过程

### 移动球

| action | 类型 | 发送方        |
| ------ | ---- | ------------- |
| move   | emit | client/server |

| 参数名  | 描述                           | 类型   |
| ------- | ------------------------------ | ------ |
| col     | 移动的列（非第一次移动可省略） | int    |

---

### 结束回合

| action   | 类型 | 发送方        |
| -------- | ---- | ------------- |
| end_turn | emit | client/server |

（无参数）

---

### 下一个球

| action    | 类型 | 发送方 |
| --------- | ---- | ------ |
| next_ball | emit | server |

| 参数名 | 描述           | 类型 |
| ------ | -------------- | ---- |
| ball   | 下一个球的类别 | int  |

---

### 游戏结束

| action   | 类型 | 发送方 |
| -------- | ---- | ------ |
| end_game | emit | server |

| 参数名 | 描述               | 类型 |
| ------ | ------------------ | ---- |
| reason | 结束原因（见下表） | int  |

| reason | 描述       |
| ------ | ---------- |
| 0      | 服务器关闭 |
| 1      | 对手离开   |
| 2      | 玩家胜利   |
| 3      | 对手胜利   |
| 4      | 玩家超时   |
| 5      | 对手超时   |

---

### 异常

通知游戏过程中出现的异常，如玩家移动时服务器认为不是该玩家的回合，或服务器与客户端的胜负判定不符。这通常意味着客户端被修改或游戏出现bug

| action    | 类型 | 发送方        |
| --------- | ---- | ------------- |
| exception | emit | client/server |

| 参数名      | 描述     | 类型   |
| ----------- | -------- | ------ |
| description | 描述异常 | string |

---

### 发送聊天

| action    | 类型 | 发送方 |
| --------- | ---- | ------ |
| send_chat | emit | client |

| 参数名 | 描述     | 类型   |
| ------ | -------- | ------ |
| text   | 聊天内容 | string |

---

### 广播聊天

| action | 类型 | 发送方 |
| ------ | ---- | ------ |
| chat   | emit | server |

| 参数名 | 描述     | 类型   |
| ------ | -------- | ------ |
| sender | 发送者   | string |
| text   | 聊天内容 | string |

---

